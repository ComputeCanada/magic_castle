
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../sequence/">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.22">
    
    
      
        <title>Terraform Cloud - Magic Castle</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.732c4fb1.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#terraform-cloud" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Magic Castle" class="md-header__button md-logo" aria-label="Magic Castle" data-md-component="logo">
      
  <img src="../img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Magic Castle
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Terraform Cloud
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Magic Castle" class="md-nav__button md-logo" aria-label="Magic Castle" data-md-component="logo">
      
  <img src="../img/logo.png" alt="logo">

    </a>
    Magic Castle
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Magic Castle Documentation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Design
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../developers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Magic Castle Developer Documentation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../matrix/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Comparison of Cloud HPC Cluster Projects
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../sequence/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Magic Castle Sequence Diagrams
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Terraform Cloud
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Terraform Cloud
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      What is Terraform Cloud?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started-with-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Getting started with Terraform Cloud
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#managing-a-magic-castle-cluster-with-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Managing a Magic Castle cluster with Terraform Cloud
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Managing a Magic Castle cluster with Terraform Cloud">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-the-workspace" class="md-nav__link">
    <span class="md-ellipsis">
      Creating the workspace
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#providing-cloud-provider-credentials-to-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Providing cloud provider credentials to Terraform Cloud
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Providing cloud provider credentials to Terraform Cloud">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws" class="md-nav__link">
    <span class="md-ellipsis">
      AWS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#azure" class="md-nav__link">
    <span class="md-ellipsis">
      Azure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#google-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Google Cloud
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openstack-ovh" class="md-nav__link">
    <span class="md-ellipsis">
      OpenStack / OVH
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#providing-dns-provider-credentials-to-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Providing DNS provider credentials to Terraform Cloud
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Providing DNS provider credentials to Terraform Cloud">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cloudflare" class="md-nav__link">
    <span class="md-ellipsis">
      CloudFlare
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#google-cloud-dns" class="md-nav__link">
    <span class="md-ellipsis">
      Google Cloud DNS
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#managing-magic-castle-variables-with-terraform-cloud-ui" class="md-nav__link">
    <span class="md-ellipsis">
      Managing Magic Castle variables with Terraform Cloud UI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applying-changes" class="md-nav__link">
    <span class="md-ellipsis">
      Applying changes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Applying changes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#auto-apply" class="md-nav__link">
    <span class="md-ellipsis">
      Auto apply
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#magic-castle-terraform-cloud-and-the-cli" class="md-nav__link">
    <span class="md-ellipsis">
      Magic Castle, Terraform Cloud and the CLI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enable-magic-castle-autoscaling" class="md-nav__link">
    <span class="md-ellipsis">
      Enable Magic Castle Autoscaling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Enable Magic Castle Autoscaling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#considerations-for-autoscaling" class="md-nav__link">
    <span class="md-ellipsis">
      Considerations for autoscaling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshoot-autoscaling-with-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshoot autoscaling with Terraform Cloud
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-is-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      What is Terraform Cloud?
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started-with-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Getting started with Terraform Cloud
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#managing-a-magic-castle-cluster-with-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Managing a Magic Castle cluster with Terraform Cloud
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Managing a Magic Castle cluster with Terraform Cloud">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-the-workspace" class="md-nav__link">
    <span class="md-ellipsis">
      Creating the workspace
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#providing-cloud-provider-credentials-to-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Providing cloud provider credentials to Terraform Cloud
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Providing cloud provider credentials to Terraform Cloud">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#aws" class="md-nav__link">
    <span class="md-ellipsis">
      AWS
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#azure" class="md-nav__link">
    <span class="md-ellipsis">
      Azure
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#google-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Google Cloud
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#openstack-ovh" class="md-nav__link">
    <span class="md-ellipsis">
      OpenStack / OVH
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#providing-dns-provider-credentials-to-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Providing DNS provider credentials to Terraform Cloud
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Providing DNS provider credentials to Terraform Cloud">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#cloudflare" class="md-nav__link">
    <span class="md-ellipsis">
      CloudFlare
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#google-cloud-dns" class="md-nav__link">
    <span class="md-ellipsis">
      Google Cloud DNS
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#managing-magic-castle-variables-with-terraform-cloud-ui" class="md-nav__link">
    <span class="md-ellipsis">
      Managing Magic Castle variables with Terraform Cloud UI
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#applying-changes" class="md-nav__link">
    <span class="md-ellipsis">
      Applying changes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Applying changes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#auto-apply" class="md-nav__link">
    <span class="md-ellipsis">
      Auto apply
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#magic-castle-terraform-cloud-and-the-cli" class="md-nav__link">
    <span class="md-ellipsis">
      Magic Castle, Terraform Cloud and the CLI
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enable-magic-castle-autoscaling" class="md-nav__link">
    <span class="md-ellipsis">
      Enable Magic Castle Autoscaling
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Enable Magic Castle Autoscaling">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#considerations-for-autoscaling" class="md-nav__link">
    <span class="md-ellipsis">
      Considerations for autoscaling
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#troubleshoot-autoscaling-with-terraform-cloud" class="md-nav__link">
    <span class="md-ellipsis">
      Troubleshoot autoscaling with Terraform Cloud
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="terraform-cloud">Terraform Cloud</h1>
<p>This document explains how to use Magic Castle with Terraform Cloud.</p>
<h2 id="what-is-terraform-cloud">What is Terraform Cloud?</h2>
<p>Terraform Cloud is HashiCorp’s managed service that allows to provision
infrastructure using a web browser or a REST API instead of the command-line.
This also means that the provisioned infrastructure parameters can be modified
by a team and the state is stored in the cloud instead of a local machine.</p>
<p>When provisioning in commercial cloud, Terraform Cloud can also
provide a cost estimate of the resources.</p>
<h2 id="getting-started-with-terraform-cloud">Getting started with Terraform Cloud</h2>
<ol>
<li>Create a <a href="https://app.terraform.io/signup/account">Terraform Cloud account</a></li>
<li><a href="https://app.terraform.io/app/organizations/new">Create an organization</a>, join one or choose one available to you</li>
</ol>
<h2 id="managing-a-magic-castle-cluster-with-terraform-cloud">Managing a Magic Castle cluster with Terraform Cloud</h2>
<h3 id="creating-the-workspace">Creating the workspace</h3>
<ol>
<li>Create a git repository in <a href="https://www.github.com/">GitHub</a>, <a href="https://www.gitlab.com/">GitLab</a>,
or any of the <a href="https://www.terraform.io/cloud-docs/vcs">version control system provider supported by Terraform Cloud</a></li>
<li>In this git repository, add a copy of the Magic Castle example <code>main.tf</code>
available for the cloud of your choice</li>
<li>Log in <a href="https://app.terraform.io/signup/account">Terraform Cloud account</a></li>
<li>Create a new workspace<ol>
<li>Choose Type: "Version control workflow"</li>
<li>Connect to VCS: choose the version control provider that hosts your repository</li>
<li>Choose the repository that contains your <code>main.tf</code></li>
<li>Configure settings: tweak the name and description to your liking</li>
<li>Click on "Create workspace"</li>
</ol>
</li>
</ol>
<p>You will be redirected automatically to your new workspace.</p>
<h3 id="providing-cloud-provider-credentials-to-terraform-cloud">Providing cloud provider credentials to Terraform Cloud</h3>
<p>Terraform Cloud will invoke Terraform command-line in a remote virtual environment.
For the CLI to be able to communicate with your cloud provider API, we need to define
environment variables that Terraform will use to authenticate. The next sections
explain which environment variables to define for each cloud provider and how to retrieve
the values of the variable from the provider.</p>
<p>If you plan on using these environment variables with multiple workspaces, it is recommended
to <a href="https://learn.hashicorp.com/tutorials/terraform/cloud-multiple-variable-sets?in=terraform/cloud#create-a-credentials-variable-set">create a credential variable set</a> in Terraform Cloud.</p>
<h4 id="aws">AWS</h4>
<p>You need to define these environment variables:
- <code>AWS_ACCESS_KEY_ID</code>
- <code>AWS_SECRET_ACCESS_KEY</code> (sensitive)</p>
<p>The value of these variables can either correspond to the value of access key created
on the <a href="https://console.aws.amazon.com/iam/home?region=ca-central-1#/security_credentials">AWS Security Credentials - Access keys</a> page, or you can add user dedicated to
Terraform Cloud in <a href="https://console.aws.amazon.com/iam/home?region=ca-central-1#/users">AWS IAM Users</a>,
and use its access key.</p>
<h4 id="azure">Azure</h4>
<p>You need to define these environment variables:
- <code>ARM_CLIENT_ID</code>
- <code>ARM_CLIENT_SECRET</code> (sensitive)
- <code>ARM_SUBSCRIPTION_ID</code>
- <code>ARM_TENANT_ID</code></p>
<p>Refer to <a href="https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs/guides/service_principal_client_secret#creating-a-service-principal">Terraform Azure Provider - Creating a Service Principal</a> to
know how to create a Service Principal and retrieve the values for these environment variables.</p>
<h4 id="google-cloud">Google Cloud</h4>
<p>You need to define this environment variable:
- <code>GOOGLE_CLOUD_KEYFILE_JSON</code> (sensitive)</p>
<p>The value of the variable will be the content of a <a href="https://cloud.google.com/iam/docs/creating-managing-service-accounts">Google Cloud service account</a>
JSON key file expressed a single line string. Example:
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;service_account&quot;</span><span class="p">,</span><span class="nt">&quot;project_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;project-id-1234&quot;</span><span class="p">,</span><span class="nt">&quot;private_key_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;abcd1234&quot;</span><span class="p">,</span><span class="err">...</span><span class="p">}</span>
</code></pre></div></p>
<p>You can use <a href="https://stedolan.github.io/jq/"><code>jq</code></a> to format the string from the JSON
file provided by Google:
<div class="highlight"><pre><span></span><code>jq<span class="w"> </span>.<span class="w"> </span>-c<span class="w"> </span>project-name-123456-abcdefjg.json
</code></pre></div></p>
<h4 id="openstack-ovh">OpenStack / OVH</h4>
<p>You need to define these environment variables:
- <code>OS_AUTH_URL</code>
- <code>OS_PROJECT_ID</code>
- <code>OS_REGION_NAME</code>
- <code>OS_INTERFACE</code>
- <code>OS_IDENTITY_API_VERSION</code>
- <code>OS_USER_DOMAIN_NAME</code>
- <code>OS_USERNAME</code>
- <code>OS_PASSWORD</code> (sensitive)</p>
<p>Apart from <code>OS_PASSWORD</code>, the values for these variables are available in
OpenStack RC file provided for your project.</p>
<p>If you prefer to use <a href="https://docs.openstack.org/keystone/queens/user/application_credentials.html">OpenStack application credentials</a>,
you need to define at least these variables:
- <code>OS_AUTH_TYPE</code> 
- <code>OS_AUTH_URL</code>
- <code>OS_APPLICATION_CREDENTIAL_ID</code>
- <code>OS_APPLICATION_CREDENTIAL_SECRET</code></p>
<p>and potentially these too:
- <code>OS_IDENTITY_API_VERSION</code> 
- <code>OS_REGION_NAME</code>
- <code>OS_INTERFACE</code></p>
<p>The values for these variables are available in OpenStack RC file provided
when creating the application credentials.</p>
<h3 id="providing-dns-provider-credentials-to-terraform-cloud">Providing DNS provider credentials to Terraform Cloud</h3>
<p>Terraform Cloud will invoke Terraform command-line in a remote virtual environment.
For the CLI to be able to communicate with your DNS provider API, we need to define
environment variables that Terraform will use to authenticate. The next sections
explain which environment variables to define for each DNS provider and how to retrieve
the values of the variable from the provider.</p>
<h4 id="cloudflare">CloudFlare</h4>
<p>Refer to DNS - <a href="../#61-cloudflare">CloudFlare</a> section of Magic Castle main documentation
to determine which environment variables needs to be set.</p>
<h4 id="google-cloud-dns">Google Cloud DNS</h4>
<p>Refer to DNS - <a href="../#62-google-cloud">Google Cloud</a> section of Magic Castle main documentation
to determine which environment variables needs to be set.</p>
<h3 id="managing-magic-castle-variables-with-terraform-cloud-ui">Managing Magic Castle variables with Terraform Cloud UI</h3>
<p>It is possible to use Terraform Cloud web interface to define variable
values in your <code>main.tf</code>. For example, you could want to define a guest
password without writing it directly in <code>main.tf</code> to avoid displaying
publicly.</p>
<p>To manage a variable with Terraform Cloud:
1. edit your <code>main.tf</code>
to define the variables you want to manage. In the following example,
we want to manage the number of nodes and the guest password.</p>
<div class="highlight"><pre><span></span><code>Add the variables at the beginning of the `main.tf`:
  ```hcl
  variable &quot;nb_nodes&quot; {}
  variable &quot;password&quot; {}
  ```

Then replace the static value by the variable in our `main.tf`,

compute node count
  ```hcl
  node = { type = &quot;p2-3gb&quot;, tags = [&quot;node&quot;], count = var.nb_nodes }
  ```
guest password
  ```hcl
  guest_passwd = var.password
  ```
</code></pre></div>
<ol>
<li>Commit and push this changes to your git repository.</li>
<li>In Terraform Cloud workspace associated with that repository, go in "Variables.</li>
<li>Under "Terraform Variables", click the "Add variable" button and create a variable for each one defined previously in the <code>main.tf</code>. Check "Sensitive" if the variable content should not never be shown in the UI or the API.</li>
</ol>
<p>You may edit the variables at any point of your cluster lifetime.</p>
<h3 id="applying-changes">Applying changes</h3>
<p>To create your cluster, apply changes made to your <code>main.tf</code> or the variables,
you will need to queue a plan. When you push to the default branch of the linked
git repository, a plan will be automatically created. You can also create a
plan manually. To do so, click on the "Queue plan manually"
button inside your workspace, then "Queue plan".</p>
<p>Once the plan has been successfully created, you can apply it using the "Runs"
section. Click on the latest queued plan, then on the "Apply plan" button at
the bottom of the plan page.</p>
<h4 id="auto-apply">Auto apply</h4>
<p>It is possible to apply automatically a successful plan. Go in the "Settings"
section, and under "Apply method" select "Auto apply". Any following successful
plan will then be automatically applied.</p>
<h2 id="magic-castle-terraform-cloud-and-the-cli">Magic Castle, Terraform Cloud and the CLI</h2>
<p>Terraform cloud only allows to apply or destroy the plan as stated in the main.tf,
but sometimes it can be useful to run some other terraform commands that are only
available through the command-line interface, for example <code>terraform taint</code>.</p>
<p>It is possible to import the terraform state of a cluster on your local computer
and then use the CLI on it.</p>
<ol>
<li>
<p>Log in Terraform cloud:
<div class="highlight"><pre><span></span><code>terraform<span class="w"> </span>login
</code></pre></div></p>
</li>
<li>
<p>Create a folder where the terraform state will be stored:
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>my-cluster-1
</code></pre></div></p>
</li>
<li>
<p>Create a file named <code>cloud.tf</code> with the following content in your cluster folder:
<div class="highlight"><pre><span></span><code><span class="nb">terraform</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">cloud</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">organization</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;REPLACE-BY-YOUR-TF-CLOUD-ORG&quot;</span>
<span class="w">    </span><span class="nb">workspaces</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;REPLACE-BY-THE-NAME-OF-YOUR-WORKSPACE&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
replace the values of <code>organization</code> and <code>name</code> with the appropriate value
for your cluster.</p>
</li>
<li>
<p>Initialize the folder and retrieve the state:
<div class="highlight"><pre><span></span><code>terraform<span class="w"> </span>init
</code></pre></div></p>
</li>
</ol>
<p>To confirm the workspace has been properly imported locally, you can list
the resources using:
<div class="highlight"><pre><span></span><code>terraform<span class="w"> </span>state<span class="w"> </span>list
</code></pre></div></p>
<h2 id="enable-magic-castle-autoscaling">Enable Magic Castle Autoscaling</h2>
<p>Magic Castle in combination with Terraform Cloud (TFE) can be configured to give
Slurm the ability to create and destroy instances based on the
job queue content.</p>
<p>To enable this feature:
1. <a href="https://app.terraform.io/app/settings/tokens">Create a TFE API Token</a> and save it somewhere safe.</p>
<div class="highlight"><pre><span></span><code>1.1. If you subscribe to Terraform Cloud Team &amp; Governance plan, you can generate
a [Team API Token](https://www.terraform.io/cloud-docs/users-teams-organizations/api-tokens#team-api-tokens).
The team associated with this token requires no access to organization and can be secret.
It does not have to include any member. Team API token is preferable as its permissions can be
restricted to the minimum required for autoscale purpose.
</code></pre></div>
<ol>
<li>
<p><a href="#creating-the-workspace">Create a workspace in TFE</a></p>
<p>2.1. Make sure the repo is private as it will contain the API token.</p>
<p>2.2. If you generated a Team API Token in 1, provide access to the workspace to the team:</p>
<ol>
<li>Workspace Settings -&gt; Team Access -&gt; Add team and permissions</li>
<li>Select the team</li>
<li>Click on "Customize permissions for this team"</li>
<li>Under "Runs" select "Apply"</li>
<li>Under "Variables" select "Read and write"</li>
<li>Leave the rest as is and click on "Assign custom permissions"</li>
</ol>
<p>2.3 In <em>Configure settings</em>, under <em>Advanced options</em>, for <em>Apply method</em>, select <em>Auto apply</em>.</p>
</li>
<li>
<p><a href="#providing-cloud-provider-credentials-to-terraform-cloud">Create the environment variables of the cloud provider credentials in TFE</a></p>
</li>
<li><a href="#managing-magic-castle-variables-with-terraform-cloud-ui">Create a variable named <code>pool</code> in TFE</a>. Set value to <code>[]</code> and check <strong>HCL</strong>.</li>
<li>Add a file named <code>data.yaml</code> in your git repo with the following content:
    <code>yaml 
    ---
    profile::slurm::controller::tfe_token: &lt;TFE API token&gt;
    profile::slurm::controller::tfe_workspace: &lt;TFE workspace id&gt;</code>
    Complete the file by replacing <code>&lt;TFE API TOKEN&gt;</code> with the token generated at step 1
    and <code>&lt;TFE workspace id&gt;</code> (i.e.: <code>ws-...</code>) by the id of the workspace created at step 2.
    It is recommended to encrypt the TFE API token before committing <code>data.yaml</code> in git. Refer
    to section <a href="../#414-eyaml_private-optional">4.14 of README.md</a> to
    know how to encrypt the token.</li>
<li>Add <code>data.yaml</code> in git and push.</li>
<li>
<p>Modify <code>main.tf</code>:</p>
<ol>
<li>If not already present, add the following definition of the pool variable at the beginning of your <code>main.tf</code>.</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="kr">variable</span><span class="w"> </span><span class="nv">&quot;pool&quot;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="na">description</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;Slurm pool of compute nodes&quot;</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>
<ol>
<li>Add instances to <code>instances</code> with the tags <code>pool</code> and <code>node</code>. These are
  the nodes that Slurm will able to create and destroy.</li>
<li>If not already present, add the following line after the instances definition to pass the list of compute nodes from Terraform cloud workspace variable to the provider module:</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="na">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.pool</span>
</code></pre></div>
<ol>
<li>On the right-hand-side of <code>public_keys =</code>, replace <code>[file("~/.ssh/id_rsa.pub")]</code>
  by a list of SSH public keys that will have admin access to the cluster.</li>
<li>After the line <code>public_keys = ...</code>, add <code>hieradata = file("data.yaml")</code>.</li>
<li>After the line <code>hieradata = ...</code>, add <code>generate_ssh_key = true</code>. This will provide
  Terraform Cloud SSH admin access to the cluster and it will be used to upload configuration
  files.</li>
<li>Stage changes, commit and push to git repo.</li>
</ol>
</li>
<li>
<p>Go to your workspace in TFE, click on Actions -&gt; Start a new run -&gt; Plan and apply -&gt; Start run.
Then, click on "Confirm &amp; Apply" and "Confirm Plan".</p>
</li>
<li>Compute nodes defined in step 8 can be modified at any point in the cluster lifetime and
more <em>pool</em> compute nodes can be added or removed if needed.</li>
</ol>
<h3 id="considerations-for-autoscaling">Considerations for autoscaling</h3>
<p>To reduce the time required for compute nodes to become available in Slurm, consider
<a href="../#1012-create-a-compute-node-image">creating a compute node image</a>.</p>
<p>JupyterHub will time out by default after 300 seconds if a node is not spawned yet. Since it may
take longer than this to spawn a node, even with an image created, consider increasing the timeout
by adding the following to your YAML configuration file: 
<div class="highlight"><pre><span></span><code>jupyterhub::jupyterhub_config_hash:
  SlurmFormSpawner:
    start_timeout: 900
</code></pre></div></p>
<p>Slurm 23 adds the possibility for <code>sinfo</code> to report nodes that are not yet spawned. This is useful
if you want JupyterHub to be aware of those nodes, for example if you want to allow to use GPU nodes
without keeping them online at all time. To use that version of Slurm, add the following to your YAML
configuration file:
<div class="highlight"><pre><span></span><code>profile::slurm::base::slurm_version: &#39;23.02&#39;
</code></pre></div></p>
<h3 id="troubleshoot-autoscaling-with-terraform-cloud">Troubleshoot autoscaling with Terraform Cloud</h3>
<p>If after enabling autoscaling with Terraform Cloud for your Magic Castle cluster,
the number of nodes does not increase when submitting jobs, verify the following
points:</p>
<ol>
<li>Go to the Terraform Cloud workspace webpage, and look for errors in the runs.
If the runs were only triggered by changes to the git repo, it means scaling signals
from the cluster do not reach the Terraform cloud workspace or no signals were sent at all.</li>
<li>Make sure the Terraform Cloud workspace id matches with the value of
<code>profile::slurm::controller::tfe_workspace</code> in <code>data.yaml</code>.</li>
<li>Execute <code>squeue</code> on the cluster, and verify the reasons why jobs are still in the queue.
If under the column <code>(Reason)</code>, there is the keyword <code>ReqNodeNotAvail</code>, it implies
Slurm tried to boot the listed nodes, but they would not show up before the timeout,
therefore Slurm marked them as down. It can happen if your cloud provider is slow to build
the instances, or following a configuration problem like in 2. When Slurm marks a node as
down, a trace is left in slurmctld's log - using zgrep on the slurm controller node (typically <code>mgmt1</code>):
    <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>zgrep<span class="w"> </span><span class="s2">&quot;marking down&quot;</span><span class="w"> </span>/var/log/slurm/slurmctld.log*
</code></pre></div>
    To tell Slurm these nodes are available again, enter the following command:
    <div class="highlight"><pre><span></span><code>sudo<span class="w"> </span>/opt/software/slurm/bin/scontrol<span class="w"> </span>update<span class="w"> </span><span class="nv">nodename</span><span class="o">=</span>node<span class="o">[</span>Y-Z<span class="o">]</span><span class="w"> </span><span class="nv">state</span><span class="o">=</span>IDLE
</code></pre></div>
    Replace <code>node[Y-Z]</code> by the hostname range listed next to <code>ReqNodeNotAvail</code> in <code>squeue</code>.</li>
<li>Under <code>mgmt1:/var/log/slurm</code>, look for errors in the file <code>slurm_resume.log</code>.</li>
</ol>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.5cfa9459.min.js"></script>
      
    
  </body>
</html>