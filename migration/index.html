
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../matrix/">
      
      
        <link rel="next" href="../otp/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.17">
    
    
      
        <title>Magic Castle Migration Guide - Magic Castle</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.bcfcd587.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#magic-castle-migration-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Magic Castle" class="md-header__button md-logo" aria-label="Magic Castle" data-md-component="logo">
      
  <img src="../img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Magic Castle
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Magic Castle Migration Guide
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Magic Castle" class="md-nav__button md-logo" aria-label="Magic Castle" data-md-component="logo">
      
  <img src="../img/logo.png" alt="logo">

    </a>
    Magic Castle
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Magic Castle Documentation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../design/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Design
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../developers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Magic Castle Developer Documentation
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../globus/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Globus Endpoint in Magic Castle
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../matrix/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Comparison of Cloud HPC Cluster Projects
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Magic Castle Migration Guide
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Magic Castle Migration Guide
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#magic-castle-10x-to-11x" class="md-nav__link">
    <span class="md-ellipsis">
      Magic Castle 10.x to 11.x
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Magic Castle 10.x to 11.x">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maintf-instances" class="md-nav__link">
    <span class="md-ellipsis">
      main.tf: instances
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maintf-storage-volumes" class="md-nav__link">
    <span class="md-ellipsis">
      main.tf: storage -&gt; volumes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maintf-other-changes" class="md-nav__link">
    <span class="md-ellipsis">
      main.tf: Other changes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#puppet-terraform_datayaml-format" class="md-nav__link">
    <span class="md-ellipsis">
      Puppet: terraform_data.yaml format
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../otp/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    One-time password
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../sequence/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Magic Castle Sequence Diagrams
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../terraform_cloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Terraform Cloud
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#magic-castle-10x-to-11x" class="md-nav__link">
    <span class="md-ellipsis">
      Magic Castle 10.x to 11.x
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Magic Castle 10.x to 11.x">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#maintf-instances" class="md-nav__link">
    <span class="md-ellipsis">
      main.tf: instances
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maintf-storage-volumes" class="md-nav__link">
    <span class="md-ellipsis">
      main.tf: storage -&gt; volumes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#maintf-other-changes" class="md-nav__link">
    <span class="md-ellipsis">
      main.tf: Other changes
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#puppet-terraform_datayaml-format" class="md-nav__link">
    <span class="md-ellipsis">
      Puppet: terraform_data.yaml format
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="magic-castle-migration-guide">Magic Castle Migration Guide</h1>
<h2 id="magic-castle-10x-to-11x">Magic Castle 10.x to 11.x</h2>
<p>Here are some helpful tips for migrating from using Magic Castle 10.x to 11.x.</p>
<p>Note that live clusters cannot be simply migrated from 10 to 11. This guide is
only meant to help you migrating existing Terraform code, not cloud resources.</p>
<h3 id="maintf-instances">main.tf: <code>instances</code></h3>
<p>The first major change is the structure for the <code>instances</code> variable.
In MC 10, the instances were defined like this:
<div class="highlight"><pre><span></span><code><span class="nb">instances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">mgmt</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;p4-6gb&quot;</span><span class="p">,</span><span class="w"> </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="nb">login</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;p2-3gb&quot;</span><span class="p">,</span><span class="w"> </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="na">node</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;p2-3gb&quot;</span><span class="p">,</span><span class="w"> </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;g1-10gb-60&quot;, count = 1, prefix = &quot;gpu&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div></p>
<p>In MC 11, the same architecture is defined like this:
<div class="highlight"><pre><span></span><code><span class="nb">instances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">mgmt</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;p4-6gb&quot;, tags = [&quot;puppet&quot;, &quot;mgmt&quot;, &quot;nfs&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="nb">login</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;p2-3gb&quot;, tags = [&quot;login&quot;, &quot;public&quot;, &quot;proxy&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="nb">node</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;p2-3gb&quot;, tags = [&quot;node&quot;</span><span class="p">],</span><span class="w"> </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="nb">gpu-node</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;g1-8gb-c4-22gb&quot;, tags = [&quot;node&quot;</span><span class="p">],</span><span class="w"> </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>List of changes:
1. Each instance' purpose in the cluster is now defined by a list
of tags instead of using its hostname. The role of each tag is
documented <a href="../">here</a>. The hostname of the instances is
therefore no longer limited to <code>mgmt</code>, <code>login</code> or <code>node</code>.
2. To define heterogeneous compute nodes, <code>prefix</code> is no longer used.
Instead, a new entry with a distinct hostname prefix is defined.
3. The count parameter is now optional and has a default value of 1.
Instance hostnames still include the index number, even when count
is not defined.</p>
<p>Note that it is possible to move the tags, and create more instances with
these tags. For example, to move the Puppet main server on an instance
separate of <code>mgmt1</code>, one could do:
<div class="highlight"><pre><span></span><code><span class="nb">instances</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">puppet</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;p4-6gb&quot;, tags = [&quot;puppet&quot;</span><span class="p">]}</span>
<span class="w">    </span><span class="nb">mgmt</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;p4-6gb&quot;, tags = [&quot;mgmt&quot;, &quot;nfs&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="nb">login</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;p2-3gb&quot;, tags = [&quot;login&quot;, &quot;public&quot;, &quot;proxy&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="nb">node</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;p2-3gb&quot;, tags = [&quot;node&quot;</span><span class="p">],</span><span class="w"> </span><span class="na">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<h3 id="maintf-storage-volumes">main.tf: <code>storage</code> -&gt; <code>volumes</code></h3>
<p>The second major change is <code>storage</code> has been replaced by the <code>volumes</code>.
In MC 10, it was possible to define only three volumes attached to <code>mgmt1</code>
with the following code:
<div class="highlight"><pre><span></span><code><span class="nb">storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="na">type</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;nfs&quot;</span>
<span class="w">    </span><span class="na">home_size</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="m">100</span>
<span class="w">    </span><span class="na">project_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span>
<span class="w">    </span><span class="na">scratch_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span>
<span class="p">}</span>
</code></pre></div></p>
<p>In MC 11, the same volumes attached to <code>mgmt1</code> are defined like this
<div class="highlight"><pre><span></span><code><span class="nb">volumes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">nfs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">home</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="na">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="nb">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="na">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="nb">scratch</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="na">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">100</span><span class="p">,</span><span class="w"> </span><span class="na">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;volumes-ssd&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>List of changes:
1. <code>type</code> is removed. Instead, a set of volumes gets to share the same
arbitrary tag, in the case above <code>nfs</code>.
2. For each instance with a tag matching of the volume tag, Magic Castle
will create the set of matching volume and attach them to the instance.
3. It is now possible to define the volume type. If left unspecified,
the cloud provider default for volume type is used.
4. Removing an instance will delete the corresponding volumes. It is no
longer possible to maintain the <code>home</code>, <code>project</code> and <code>scratch</code> volumes
while setting the <code>mgmt</code> count at 0.</p>
<h3 id="maintf-other-changes">main.tf: Other changes</h3>
<ul>
<li><code>root_disk_size</code> variable has been removed. You can define the root
disk size of each instance type independently by defining <code>disk_size</code>
in the instance attributes' map.</li>
<li>Azure <code>managed_disk_type</code> has been removed. The disk type can be
defined for instances using the <code>disk_type</code> attribute in the instance
attributes' map and the disk type for attached volume can be defined
with <code>type</code> in the volumes map. This attribute works for every cloud
provider, not only Azure.</li>
</ul>
<h3 id="puppet-terraform_datayaml-format">Puppet: <code>terraform_data.yaml</code> format</h3>
<p>Instead of fetching a template of a YAML file, Magic Castle now writes its own YAML file that is than integrated in the Puppet data hierarchy.</p>
<p>In MC 10, <code>terraform_data.yaml</code> looked like this when populated on <code>mgmt1</code>
<div class="highlight"><pre><span></span><code><span class="nn">---</span>
<span class="nt">profile::base::sudoer_username</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;centos&quot;</span>

<span class="nt">profile::consul::acl_api_token</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;123-abc-def-456&quot;</span>

<span class="nt">profile::freeipa::base::admin_passwd</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;aaaaBBBBcccDDee&quot;</span>
<span class="nt">profile::freeipa::base::domain_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;phoenix.calculquebec.cloud&quot;</span>
<span class="nt">profile::freeipa::mokey::passwd</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;aaaaBBBBcccDDee&quot;</span>

<span class="nt">profile::accounts::guests::passwd</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;sneaky.sensitive.girafe&quot;</span>
<span class="nt">profile::accounts::guests::nb_accounts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>

<span class="nt">profile::slurm::base::cluster_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;phoenix&quot;</span>
<span class="nt">profile::slurm::base::munge_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;aaaBbbCc1231aF&quot;</span>
<span class="nt">profile::slurm::accounting::password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;aaaaBBBBcccDDee&quot;</span>

<span class="nt">profile::freeipa::client::server_ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.0.0.0.2&quot;</span>
<span class="nt">profile::consul::client::server_ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.0.0.2&quot;</span>
<span class="nt">profile::nfs::client::server_ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.0.0.2&quot;</span>

<span class="nt">profile::nfs::server::home_devices</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/dev/disk/by-id/virtio-*&quot;</span>
<span class="nt">profile::nfs::server::project_devices</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/dev/disk/by-id/virtio-*&quot;</span>
<span class="nt">profile::nfs::server::scratch_devices</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/dev/disk/by-id/virtio-*&quot;</span>

<span class="nt">profile::reverse_proxy::domain_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;phoenix.calculquebec.cloud&quot;</span>
</code></pre></div></p>
<p>In MC 11, the <code>terraform_data.yaml</code> matching the preceding <code>instances</code> and <code>volumes</code>
configuration could look like this:
<div class="highlight"><pre><span></span><code><span class="nt">terraform</span><span class="p">:</span>
<span class="w">  </span><span class="nt">instances</span><span class="p">:</span>
<span class="w">    </span><span class="nt">mgmt1</span><span class="p">:</span>
<span class="w">      </span><span class="nt">local_ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.0.0.1&quot;</span>
<span class="w">      </span><span class="nt">public_ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">      </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;puppet&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;nfs&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;mgmt&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">hostkeys</span><span class="p">:</span>
<span class="w">        </span><span class="nt">rsa</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ssh-rsa</span><span class="nv"> </span><span class="s">...&quot;</span>
<span class="w">    </span><span class="nt">login1</span><span class="p">:</span>
<span class="w">      </span><span class="nt">local_ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.0.0.2&quot;</span>
<span class="w">      </span><span class="nt">public_ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;132.219.29.10&quot;</span>
<span class="w">      </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;login&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;public&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;proxy&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">hostkeys</span><span class="p">:</span>
<span class="w">        </span><span class="nt">rsa</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ssh-rsa</span><span class="nv"> </span><span class="s">...&quot;</span>
<span class="w">    </span><span class="nt">node1</span><span class="p">:</span>
<span class="w">      </span><span class="nt">local_ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.0.0.3&quot;</span>
<span class="w">      </span><span class="nt">public_ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">      </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;node&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">hostkeys</span><span class="p">:</span>
<span class="w">        </span><span class="nt">rsa</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ssh-rsa</span><span class="nv"> </span><span class="s">...&quot;</span>
<span class="w">    </span><span class="nt">gpu-node1</span><span class="p">:</span>
<span class="w">      </span><span class="nt">local_ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;10.0.0.4&quot;</span>
<span class="w">      </span><span class="nt">public_ip</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span>
<span class="w">      </span><span class="nt">tags</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;node&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">hostkeys</span><span class="p">:</span>
<span class="w">        </span><span class="nt">rsa</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ssh-rsa</span><span class="nv"> </span><span class="s">...&quot;</span>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">    </span><span class="nt">nfs</span><span class="p">:</span>
<span class="w">      </span><span class="nt">home</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/dev/disk/by-id/virtio-*&quot;</span>
<span class="w">      </span><span class="nt">project</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/dev/disk/by-id/virtio-*&quot;</span>
<span class="w">      </span><span class="nt">scratch</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;/dev/disk/by-id/virtio-*&quot;</span>
<span class="w">  </span><span class="nt">tag_ip</span><span class="p">:</span>
<span class="w">    </span><span class="nt">mgmt</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0.0.1</span>
<span class="w">    </span><span class="nt">nfs</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0.0.1</span>
<span class="w">    </span><span class="nt">puppet</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0.0.1</span>
<span class="w">    </span><span class="nt">login</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0.0.2</span>
<span class="w">    </span><span class="nt">node</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0.0.3</span>
<span class="w">    </span><span class="nt">gpu-node</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0.0.4</span>
<span class="w">  </span><span class="nt">data</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cluster_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;phoenix&quot;</span>
<span class="w">    </span><span class="nt">consul_token</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;123-abc-def-456&quot;</span>
<span class="w">    </span><span class="nt">domain_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;phoenix.calculquebec.cloud&quot;</span>
<span class="w">    </span><span class="nt">freeipa_passwd</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;aaaaBBBBcccDDee&quot;</span>
<span class="w">    </span><span class="nt">guest_passwd</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;sneaky.sensitive.girafe&quot;</span>
<span class="w">    </span><span class="nt">munge_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;aaaBbbCc1231aF&quot;</span>
<span class="w">    </span><span class="nt">nb_users</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span>
<span class="w">    </span><span class="nt">sudoer_username</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;centos&quot;</span>
</code></pre></div></p>
<p>The values from <code>terraform_data.yaml</code> are input in Puppet classes hieradata
using aliases in <code>common.yaml</code>. For example, to number of guest accounts
that corresponds to <code>profile::accounts::guests::nb_accounts</code> is set to
the <code>nb_users</code> value like this in <code>common.yaml</code>:
<div class="highlight"><pre><span></span><code><span class="nt">profile::accounts::guests::nb_accounts</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;%{alias(&#39;terraform.data.nb_users&#39;)}&quot;</span>
</code></pre></div></p>
<p><strong>Important note</strong>: Because <code>terraform_data.yaml</code> now includes information about the
resources, it will be overwritten every time something is modified in <code>main.tf</code>. It
is therefore no longer recommended to edit it manually. All changes to this file
should be perform by Terraform. The <a href="../">documentation</a> has been
updated accordingly.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["content.code.copy"], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.1e8ae164.min.js"></script>
      
    
  </body>
</html>